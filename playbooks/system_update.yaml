---
- name: Bezpieczna aktualizacja systemu operacyjnego
  hosts: linux
  gather_facts: yes
  vars:
    discord_webhook_id: ""
    discord_webhook_token: ""
    
  tasks:
    - name: Blok aktualizacji z obsługą błędów
      block:
        - name: Aktualizacja pakietów do najnowszej wersji
          ansible.builtin.apt:
            upgrade: safe
            update_cache: yes
            autoclean: yes
            autoremove: yes
          environment:
            DEBIAN_FRONTEND: noninteractive
          register: upgrade_result

        - name: Sprawdzenie czy wymagany restart
          ansible.builtin.stat:
            path: /var/run/reboot-required
          register: reboot_required

        - name: Wyświetlenie podsumowania
          ansible.builtin.debug:
            msg:
              - "Aktualizacja zakończona pomyślnie"
              - "Restart wymagany: {{ 'TAK' if reboot_required.stat.exists else 'NIE' }}"

      rescue:
        - name: Wysłanie powiadomienia na Discord
          community.general.discord:
            webhook_id: "{{ discord_webhook_id }}"
            webhook_token: "{{ discord_webhook_token }}"
            embeds:
              - title: "⚠️ BŁĄD AKTUALIZACJI SYSTEMU"
                description: "Aktualizacja systemu zakończyła się błędem"
                color: 15158332
                fields:
                  - name: "Serwer"
                    value: "{{ inventory_hostname }}"
                  - name: "Data"
                    value: "{{ ansible_date_time.iso8601 }}"
                  - name: "Błąd"
                    value: "{{ ansible_failed_result.msg | default('Nieznany błąd') }}"
                timestamp: "{{ ansible_date_time.iso8601 }}"
          delegate_to: localhost
          become: no
          when: discord_webhook_id != "" and discord_webhook_token != ""

        - name: Niepowodzenie aktualizacji
          ansible.builtin.fail:
            msg: "Aktualizacja zakończyła się błędem"
